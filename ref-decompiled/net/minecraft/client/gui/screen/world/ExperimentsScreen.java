/*
 * Decompiled with CFR 0.152.
 * 
 * Could not load the following classes:
 *  com.google.common.collect.Lists
 *  it.unimi.dsi.fastutil.objects.Object2BooleanLinkedOpenHashMap
 *  it.unimi.dsi.fastutil.objects.Object2BooleanMap
 *  net.fabricmc.api.EnvType
 *  net.fabricmc.api.Environment
 *  net.minecraft.client.gui.screen.Screen
 *  net.minecraft.client.gui.screen.world.ExperimentsScreen
 *  net.minecraft.client.gui.screen.world.WorldScreenOptionGrid
 *  net.minecraft.client.gui.screen.world.WorldScreenOptionGrid$Builder
 *  net.minecraft.client.gui.widget.ButtonWidget
 *  net.minecraft.client.gui.widget.ClickableWidget
 *  net.minecraft.client.gui.widget.DirectionalLayoutWidget
 *  net.minecraft.client.gui.widget.LayoutWidget
 *  net.minecraft.client.gui.widget.MultilineTextWidget
 *  net.minecraft.client.gui.widget.ScrollableLayoutWidget
 *  net.minecraft.client.gui.widget.ThreePartsLayoutWidget
 *  net.minecraft.client.gui.widget.Widget
 *  net.minecraft.client.resource.language.I18n
 *  net.minecraft.resource.ResourcePackManager
 *  net.minecraft.resource.ResourcePackProfile
 *  net.minecraft.resource.ResourcePackSource
 *  net.minecraft.screen.ScreenTexts
 *  net.minecraft.text.Text
 *  net.minecraft.util.Formatting
 *  org.jspecify.annotations.Nullable
 */
package net.minecraft.client.gui.screen.world;

import com.google.common.collect.Lists;
import it.unimi.dsi.fastutil.objects.Object2BooleanLinkedOpenHashMap;
import it.unimi.dsi.fastutil.objects.Object2BooleanMap;
import java.util.ArrayList;
import java.util.function.Consumer;
import net.fabricmc.api.EnvType;
import net.fabricmc.api.Environment;
import net.minecraft.client.gui.screen.Screen;
import net.minecraft.client.gui.screen.world.WorldScreenOptionGrid;
import net.minecraft.client.gui.widget.ButtonWidget;
import net.minecraft.client.gui.widget.ClickableWidget;
import net.minecraft.client.gui.widget.DirectionalLayoutWidget;
import net.minecraft.client.gui.widget.LayoutWidget;
import net.minecraft.client.gui.widget.MultilineTextWidget;
import net.minecraft.client.gui.widget.ScrollableLayoutWidget;
import net.minecraft.client.gui.widget.ThreePartsLayoutWidget;
import net.minecraft.client.gui.widget.Widget;
import net.minecraft.client.resource.language.I18n;
import net.minecraft.resource.ResourcePackManager;
import net.minecraft.resource.ResourcePackProfile;
import net.minecraft.resource.ResourcePackSource;
import net.minecraft.screen.ScreenTexts;
import net.minecraft.text.Text;
import net.minecraft.util.Formatting;
import org.jspecify.annotations.Nullable;

/*
 * Exception performing whole class analysis ignored.
 */
@Environment(value=EnvType.CLIENT)
public class ExperimentsScreen
extends Screen {
    private static final Text TITLE = Text.translatable((String)"selectWorld.experiments");
    private static final Text INFO_TEXT = Text.translatable((String)"selectWorld.experiments.info").formatted(Formatting.RED);
    private static final int EXPERIMENTS_LIST_WIDTH = 310;
    private static final int EXPERIMENTS_LIST_HEIGHT = 130;
    private final ThreePartsLayoutWidget experimentToggleList = new ThreePartsLayoutWidget((Screen)this);
    private final Screen parent;
    private final ResourcePackManager resourcePackManager;
    private final Consumer<ResourcePackManager> applier;
    private final Object2BooleanMap<ResourcePackProfile> experiments = new Object2BooleanLinkedOpenHashMap();
    private @Nullable ScrollableLayoutWidget experimentsList;

    public ExperimentsScreen(Screen parent, ResourcePackManager resourcePackManager, Consumer<ResourcePackManager> applier) {
        super(TITLE);
        this.parent = parent;
        this.resourcePackManager = resourcePackManager;
        this.applier = applier;
        for (ResourcePackProfile resourcePackProfile : resourcePackManager.getProfiles()) {
            if (resourcePackProfile.getSource() != ResourcePackSource.FEATURE) continue;
            this.experiments.put((Object)resourcePackProfile, resourcePackManager.getEnabledProfiles().contains(resourcePackProfile));
        }
    }

    protected void init() {
        this.experimentToggleList.addHeader(TITLE, this.textRenderer);
        DirectionalLayoutWidget directionalLayoutWidget = (DirectionalLayoutWidget)this.experimentToggleList.addBody((Widget)DirectionalLayoutWidget.vertical());
        directionalLayoutWidget.add((Widget)new MultilineTextWidget(INFO_TEXT, this.textRenderer).setMaxWidth(310), positioner -> positioner.marginBottom(15));
        WorldScreenOptionGrid.Builder builder = WorldScreenOptionGrid.builder((int)299).withTooltipBox(2, true).setRowSpacing(4);
        this.experiments.forEach((pack, enabled2) -> builder.add(ExperimentsScreen.getDataPackName((ResourcePackProfile)pack), () -> this.experiments.getBoolean(pack), enabled -> this.experiments.put(pack, enabled.booleanValue())).tooltip(pack.getDescription()));
        LayoutWidget layoutWidget = builder.build().getLayout();
        this.experimentsList = new ScrollableLayoutWidget(this.client, layoutWidget, 130);
        this.experimentsList.setWidth(310);
        directionalLayoutWidget.add((Widget)this.experimentsList);
        DirectionalLayoutWidget directionalLayoutWidget2 = (DirectionalLayoutWidget)this.experimentToggleList.addFooter((Widget)DirectionalLayoutWidget.horizontal().spacing(8));
        directionalLayoutWidget2.add((Widget)ButtonWidget.builder((Text)ScreenTexts.DONE, button -> this.applyAndClose()).build());
        directionalLayoutWidget2.add((Widget)ButtonWidget.builder((Text)ScreenTexts.CANCEL, button -> this.close()).build());
        this.experimentToggleList.forEachChild(widget -> {
            ClickableWidget cfr_ignored_0 = (ClickableWidget)this.addDrawableChild(widget);
        });
        this.refreshWidgetPositions();
    }

    private static Text getDataPackName(ResourcePackProfile packProfile) {
        String string = "dataPack." + packProfile.getId() + ".name";
        return I18n.hasTranslation((String)string) ? Text.translatable((String)string) : packProfile.getDisplayName();
    }

    protected void refreshWidgetPositions() {
        this.experimentsList.setHeight(130);
        this.experimentToggleList.refreshPositions();
        int i = this.height - this.experimentToggleList.getFooterHeight() - this.experimentsList.getNavigationFocus().getBottom();
        this.experimentsList.setHeight(this.experimentsList.getHeight() + i);
    }

    public Text getNarratedTitle() {
        return ScreenTexts.joinSentences((Text[])new Text[]{super.getNarratedTitle(), INFO_TEXT});
    }

    public void close() {
        this.client.setScreen(this.parent);
    }

    private void applyAndClose() {
        ArrayList list = new ArrayList(this.resourcePackManager.getEnabledProfiles());
        ArrayList list2 = new ArrayList();
        this.experiments.forEach((pack, enabled) -> {
            list.remove(pack);
            if (enabled) {
                list2.add(pack);
            }
        });
        list.addAll(Lists.reverse(list2));
        this.resourcePackManager.setEnabledProfiles(list.stream().map(ResourcePackProfile::getId).toList());
        this.applier.accept(this.resourcePackManager);
    }
}

