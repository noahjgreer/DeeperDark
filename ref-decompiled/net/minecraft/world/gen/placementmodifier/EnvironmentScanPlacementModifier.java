package net.minecraft.world.gen.placementmodifier;

import com.mojang.serialization.Codec;
import com.mojang.serialization.MapCodec;
import com.mojang.serialization.codecs.RecordCodecBuilder;
import java.util.stream.Stream;
import net.minecraft.util.math.BlockPos;
import net.minecraft.util.math.Direction;
import net.minecraft.util.math.random.Random;
import net.minecraft.world.StructureWorldAccess;
import net.minecraft.world.gen.blockpredicate.BlockPredicate;
import net.minecraft.world.gen.feature.FeaturePlacementContext;

public class EnvironmentScanPlacementModifier extends PlacementModifier {
   private final Direction direction;
   private final BlockPredicate targetPredicate;
   private final BlockPredicate allowedSearchPredicate;
   private final int maxSteps;
   public static final MapCodec MODIFIER_CODEC = RecordCodecBuilder.mapCodec((instance) -> {
      return instance.group(Direction.VERTICAL_CODEC.fieldOf("direction_of_search").forGetter((placementModifier) -> {
         return placementModifier.direction;
      }), BlockPredicate.BASE_CODEC.fieldOf("target_condition").forGetter((placementModifier) -> {
         return placementModifier.targetPredicate;
      }), BlockPredicate.BASE_CODEC.optionalFieldOf("allowed_search_condition", BlockPredicate.alwaysTrue()).forGetter((placementModifier) -> {
         return placementModifier.allowedSearchPredicate;
      }), Codec.intRange(1, 32).fieldOf("max_steps").forGetter((placementModifier) -> {
         return placementModifier.maxSteps;
      })).apply(instance, EnvironmentScanPlacementModifier::new);
   });

   private EnvironmentScanPlacementModifier(Direction direction, BlockPredicate targetPredicate, BlockPredicate allowedSearchPredicate, int maxSteps) {
      this.direction = direction;
      this.targetPredicate = targetPredicate;
      this.allowedSearchPredicate = allowedSearchPredicate;
      this.maxSteps = maxSteps;
   }

   public static EnvironmentScanPlacementModifier of(Direction direction, BlockPredicate targetPredicate, BlockPredicate allowedSearchPredicate, int maxSteps) {
      return new EnvironmentScanPlacementModifier(direction, targetPredicate, allowedSearchPredicate, maxSteps);
   }

   public static EnvironmentScanPlacementModifier of(Direction direction, BlockPredicate targetPredicate, int maxSteps) {
      return of(direction, targetPredicate, BlockPredicate.alwaysTrue(), maxSteps);
   }

   public Stream getPositions(FeaturePlacementContext context, Random random, BlockPos pos) {
      BlockPos.Mutable mutable = pos.mutableCopy();
      StructureWorldAccess structureWorldAccess = context.getWorld();
      if (!this.allowedSearchPredicate.test(structureWorldAccess, mutable)) {
         return Stream.of();
      } else {
         int i = 0;

         while(true) {
            if (i < this.maxSteps) {
               if (this.targetPredicate.test(structureWorldAccess, mutable)) {
                  return Stream.of(mutable);
               }

               mutable.move(this.direction);
               if (structureWorldAccess.isOutOfHeightLimit(mutable.getY())) {
                  return Stream.of();
               }

               if (this.allowedSearchPredicate.test(structureWorldAccess, mutable)) {
                  ++i;
                  continue;
               }
            }

            if (this.targetPredicate.test(structureWorldAccess, mutable)) {
               return Stream.of(mutable);
            }

            return Stream.of();
         }
      }
   }

   public PlacementModifierType getType() {
      return PlacementModifierType.ENVIRONMENT_SCAN;
   }
}
