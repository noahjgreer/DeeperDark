# Updates - Anvil & Fortune Balance

## Changes Made (January 13, 2026)

### 1. Fixed Anvil Free Repairs Issue ✅
**Problem**: When repair cost was set to 0, items couldn't be removed from the anvil output slot.

**Solution**: Added a `canTakeOutput` injection that allows taking items even when cost is 0.

**How it works**:
- If cost is 0: Always allow taking the output (free operation)
- If cost > 0: Check if player has enough levels
- Creative mode players can always take output

### 2. Updated Fortune Drop Chances ✅
Changed default Fortune percentages to be less powerful:

| Fortune Level | Old Chance | New Chance | Average Drops (per ore) |
|---------------|------------|------------|-------------------------|
| Fortune I     | 25%        | **16.66%** | ~1.17x                 |
| Fortune II    | 50%        | **33.33%** | ~1.33x                 |
| Fortune III   | 75%        | **50%**    | ~1.50x                 |

**Note**: All Fortune still caps at 2x drops maximum.

## New Default Config Values

```yaml
# Anvil costs
anvilRepairCost: 0      # Free repairs (fixed to work properly)
anvilEnchantCost: 5     # 5 levels for enchanting

# Fortune enchantment
customFortuneEnabled: true
fortune1DropChance: 0.1666   # 16.66% chance
fortune2DropChance: 0.3333   # 33.33% chance  
fortune3DropChance: 0.50     # 50% chance
fortuneMaxDrops: 2           # Maximum 2x drops
```

## Testing Your Changes

### Test Anvil Repairs
1. Damage a diamond pickaxe
2. Put it in anvil with a diamond
3. Cost should show as 0
4. You should be able to take the repaired item

### Test Fortune
Mine 100 diamond ores with each Fortune level and count the drops:

- **Fortune I**: Should get around 117 diamonds (16.66% bonus)
- **Fortune II**: Should get around 133 diamonds (33.33% bonus)
- **Fortune III**: Should get around 150 diamonds (50% bonus)

## Files Modified

1. **AnvilScreenHandlerMixin.java**
   - Added `canTakeOutput` injection to allow free repairs
   - Properly handles cost = 0 case

2. **DeeperDarkConfig.java**
   - Updated Fortune default values to 16.66%, 33.33%, 50%
   - Updated config comments to reflect new percentages

3. **Config file deleted**
   - Old config removed so new defaults take effect
   - Will be regenerated on next run with new values

## Expected Fortune Performance

Compared to vanilla Fortune III (which can drop 4+ diamonds per ore):

| System | Min | Max | Average | Notes |
|--------|-----|-----|---------|-------|
| Vanilla Fortune III | 1 | 4+ | ~2.2 | No cap |
| Custom Fortune III | 1 | 2 | 1.5 | 50% chance, capped at 2x |
| Custom Fortune II | 1 | 2 | 1.33 | 33.33% chance, capped at 2x |
| Custom Fortune I | 1 | 2 | 1.17 | 16.66% chance, capped at 2x |

## Why These Percentages?

The new Fortune chances are based on a more balanced progression:
- **Fortune I**: Slight bonus (1/6 chance)
- **Fortune II**: Moderate bonus (1/3 chance)
- **Fortune III**: Solid bonus (1/2 chance), but still way less than vanilla

This prevents Fortune III from being too powerful while still making each upgrade feel meaningful.

## Next Steps

1. Delete old config: `run/config/deeperdark.yaml` (already done)
2. Run `.\gradlew runClient` or `.\gradlew runServer`
3. New config will be generated with updated values
4. Test anvil repairs and Fortune enchantments
5. Adjust config values if needed

## Troubleshooting

**Anvil still won't let me take items**: 
- Make sure you deleted the old config
- Rebuild the mod with `.\gradlew build`
- Check that `anvilRepairCost: 0` is in the new config

**Fortune seems wrong**:
- Check config values in `config/deeperdark.yaml`
- Make sure `customFortuneEnabled: true`
- Test with larger sample sizes (100+ blocks)

